<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>n8n Voice Agent</title>
    <style>
      /* Center the button and player on the page */
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background: #fafafa;
      }
      #mic {
        /* make it even larger */
        width: 80vw;               /* 80% of viewport width */
        max-width: 700px;          /* but no more than 700px */
        height: 80vw;              /* same as width */
        max-height: 700px;         /* but no more than 700px */
        font-size: 6rem;           /* much larger label */
        border: none;
        border-radius: 50%;
        background: #0069ff;
        color: white;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1rem;
      }
      /* on very small screens, go nearly edge-to-edge */
      @media only screen and (max-width: 400px) {
        #mic {
          width: 95vw;
          height: 95vw;
          font-size: 7rem;
        }
      }
      #mic.recording { background: #cc0000; }
      #mic.working   { background: #f0c000; color: #333; }

      audio {
        width: 90%;
        max-width: 600px;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <button id="mic">Toggle</button>
    <audio id="player" controls style="display:none;"></audio>

    <script>
      // unlock audio on first gesture
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const audioCtx = new AudioCtx();

      let recorder, micStream = null, audioChunks = [], isRecording = false;
      const micButton = document.getElementById('mic');
      const player    = document.getElementById('player');

      micButton.onclick = async () => {
        if (audioCtx.state === 'suspended') {
          const buf = audioCtx.createBuffer(1,1,audioCtx.sampleRate);
          const src = audioCtx.createBufferSource();
          src.buffer = buf;
          src.connect(audioCtx.destination);
          src.start();
          await audioCtx.resume();
        }

        if (!isRecording) {
          audioChunks = [];
          if (micStream) micStream.getTracks().forEach(t=>t.stop()), micStream = null;
          try {
            micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          } catch {
            alert('Unable to access microphone.');
            return;
          }
          recorder = new MediaRecorder(micStream);
          recorder.ondataavailable = e => audioChunks.push(e.data);
          recorder.start();
          isRecording = true;
          micButton.textContent = 'Stop';
          micButton.classList.add('recording');
          micButton.classList.remove('working');
          player.style.display = 'none';
        } else {
          recorder.stop();
          recorder.onstop = async () => {
            micButton.textContent = 'Working';
            micButton.classList.remove('recording');
            micButton.classList.add('working');
            isRecording = false;
            if (micStream) micStream.getTracks().forEach(t=>t.stop()), micStream = null;
            if (!audioChunks.length) { alert('No audio captured.'); resetButton(); return; }

            const blob = new Blob(audioChunks, { type:'audio/webm' });
            const file = new File([blob],'voice.webm',{ type:'audio/webm' });
            const form = new FormData(); form.append('data', file);

            let res;
            try { res = await fetch('https://wonderli.app.n8n.cloud/webhook/voice-agent',{method:'POST',body:form}); }
            catch { alert('Network error sending audio.'); resetButton(); return; }
            if (!res.ok) { alert('Server error: '+res.status); resetButton(); return; }

            let tts;
            try { tts = await res.blob(); }
            catch { alert('Error receiving audio.'); resetButton(); return; }

            const url = URL.createObjectURL(tts);
            player.src = url;
            player.style.display = 'block';
            player.play().catch(()=>{});

            resetButton();
          };
        }
      };

      function resetButton() {
        isRecording = false;
        micButton.textContent = 'Toggle';
        micButton.classList.remove('recording','working');
      }
    </script>
  </body>
</html>
